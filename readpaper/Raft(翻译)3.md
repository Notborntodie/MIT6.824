# Raft

[TOC]

### 5.5 Follower and candidate crashes

相比于Leader的崩溃，Follower和Candidate的崩溃处理要简单得多，并且它们的处理方式相同。如果一个Follower或Candidate崩溃了，那么未来发送给它的RequestVote和AppendEntries RPC将失败。Raft通过无限重试来处理这些故障；如果崩溃的服务器重新启动，那么RPC将成功完成。如果服务器在完成RPC但未响应之前崩溃，那么它重新启动后将再次接收到相同的RPC。Raft的RPC是幂等的，因此这不会造成任何损害。例如，如果一个Follower接收到一个AppendEntries请求，其中包含其日志中已经存在的日志条目，它将在新请求中忽略这些条目。

### 5.6 Timing and availability

首先，作者强调了安全性不应该依赖于时序，也就是说，无论事件的发生速度如何，系统都不能产生错误的结果。然而，可用性必然会依赖于时序，比如如果消息交换所需的时间比服务器崩溃之间的典型时间还要长，那么候选人就不会保持足够长的时间来赢得选举，而没有一个稳定的领导者，Raft就无法取得进展。

**在Raft中，选举是时序最关键的部分**。只要系统满足以下时序要求，Raft就能够选举并维护一个稳定的领导者：

broadcastTime ≪ electionTimeout ≪ MTBF

在这个不等式中，broadcastTime是一个服务器并行发送RPC并接收响应所需的平均时间；electionTimeout是第5.2节中描述的选举超时时间；MTBF是单个服务器故障之间的平均时间。广播时间应该比选举超时时间小几个数量级，以便领导者可以可靠地发送心跳消息，从而防止跟随者开始选举；考虑到选举超时使用的随机方法，这个不等式也使得分裂投票不太可能发生。选举超时应该比MTBF小几个数量级，以便系统可以稳步前进。当领导者崩溃时，系统将不可用约为选举超时的时间；我们希望这只代表总时间的一小部分。

广播时间和MTBF是底层系统的属性，而选举超时是我们必须选择的。Raft的RPC通常需要接收方将信息持久化到稳定存储中，因此广播时间可能在0.5毫秒到20毫秒之间，具体取决于存储技术。因此，选举超时很可能在10毫秒到500毫秒之间。典型的服务器MTBF是几个月或更长时间，这轻松满足时序要求。



## chatGPT

### 什么叫Raft RPCs are idempotent?



您好，我理解您的问题是想了解Raft中的RPC是什么意思，以及其中提到的“idempotent”是什么意思。在Raft中，RPC是远程过程调用（Remote Procedure Call）的缩写，指在分布式系统中，一个节点（例如客户端或服务器）请求另一个节点执行某个过程或方法。在Raft中，主要有两种类型的RPC：RequestVote和AppendEntries。

而“idempotent”表示一个函数或操作，无论执行多少次，都不会产生不同的结果。在Raft中，所有RPC都是幂等的，这意味着如果一个RPC在某个节点执行了多次，它对系统状态的影响应该是一样的。这是因为Raft设计的目的之一是为了能够容忍网络故障或节点故障等情况下的不可靠性，RPC的幂等性可以保证在系统恢复正常后，不会因为之前的执行出现重复或错误操作。



### electionTimeout远大于broadcastTime我理解，那么不同服务器随机产生的electionTimeout之间的差距是不是也要远大于broadcastTime

是的，确保不同服务器选举超时时间的随机化程度很高是很重要的。在Raft中，为了避免出现多个服务器同时发起选举的情况，每个服务器都会随机生成自己的选举超时时间，这样就可以最大程度地避免同时出现多个服务器成为候选人的情况。

如果服务器选举超时时间之间的差距很小，那么在一个领导者宕机的情况下，多个服务器可能会在同一时刻成为候选人，从而导致竞争激烈，难以产生一个稳定的领导者。因此，为了确保系统稳定，不同服务器随机产生的选举超时时间之间的差距需要足够大，同时也要远大于广播时间。这样一来，就能够保证只有一个服务器成为候选人，最终稳定地成为领导者，从而保证整个系统的正确性。



### MTBF是单个服务器故障之间的平均时间,为什么MTBF要远大于electionTimeout?

MTBF是单个服务器故障之间的平均时间，而electionTimeout是选举超时的时间，两者是不同的概念。

在Raft中，当一个服务器成为leader后，它会发送心跳信号以保持它的leadership，这些心跳信号的发送时间间隔为electionTimeout的一半。如果followers在electionTimeout的时间内没有收到来自leader的心跳信号，它们就会开始选举新的leader。因此，electionTimeout的大小会直接影响leader选举的过程。

MTBF应该远大于electionTimeout，是因为如果MTBF比electionTimeout小，那么服务器的故障很可能会导致频繁的leader选举，这会对系统的性能产生负面影响。如果MTBF比electionTimeout大，那么服务器故障对系统的影响就会比较小，而且在服务器故障期间，系统的可用性也可以通过raft协议来保障。

